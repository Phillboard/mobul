---
description: OAuth Integration Guide - Google and Apple Sign-In Implementation
globs: ["**/Auth*.tsx", "**/AuthContext.tsx", "**/auth/**"]
---

# OAuth Integration - Google & Apple Sign-In

## TASK OVERVIEW

Add social authentication (Google + Apple) to the existing email/password auth system.

## CURRENT STATE

- Auth uses Supabase Auth with email/password
- AuthContext at `src/contexts/AuthContext.tsx`
- Auth UI at `src/pages/Auth.tsx`
- No OAuth providers currently enabled

## IMPLEMENTATION STEPS

### Step 1: Update AuthContext.tsx

Add these methods to the AuthContext:

```typescript
// Add to AuthContextType interface
signInWithGoogle: () => Promise<{ error: AuthError | null }>;
signInWithApple: () => Promise<{ error: AuthError | null }>;

// Add implementations in AuthProvider
const signInWithGoogle = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`,
      queryParams: {
        access_type: 'offline',
        prompt: 'consent',
      },
    },
  });
  return { error };
};

const signInWithApple = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'apple',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`,
    },
  });
  return { error };
};

// Add to context value
signInWithGoogle,
signInWithApple,
```

### Step 2: Create AuthCallback.tsx

Create `src/pages/AuthCallback.tsx`:

```typescript
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '@/integrations/supabase/client';
import { Loader2 } from 'lucide-react';

export default function AuthCallback() {
  const navigate = useNavigate();

  useEffect(() => {
    const handleCallback = async () => {
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        console.error('OAuth callback error:', error);
        navigate('/auth?error=' + encodeURIComponent(error.message));
        return;
      }

      if (session) {
        // Check if profile exists, create if not
        const { data: profile } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', session.user.id)
          .single();

        if (!profile) {
          // Profile will be created by database trigger
          // Just wait a moment for it to be ready
          await new Promise(resolve => setTimeout(resolve, 1000));
        }

        navigate('/');
      } else {
        navigate('/auth');
      }
    };

    handleCallback();
  }, [navigate]);

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <Loader2 className="h-8 w-8 animate-spin mx-auto mb-4" />
        <p>Completing sign in...</p>
      </div>
    </div>
  );
}
```

### Step 3: Update Routes

In `src/App.tsx` or router configuration, add:

```typescript
<Route path="/auth/callback" element={<AuthCallback />} />
```

### Step 4: Update Auth.tsx UI

Add OAuth buttons to the sign-in form:

```tsx
import { FcGoogle } from 'react-icons/fc';
import { FaApple } from 'react-icons/fa';

// Inside the component, after the form
<div className="relative my-4">
  <div className="absolute inset-0 flex items-center">
    <span className="w-full border-t" />
  </div>
  <div className="relative flex justify-center text-xs uppercase">
    <span className="bg-background px-2 text-muted-foreground">
      Or continue with
    </span>
  </div>
</div>

<div className="grid grid-cols-2 gap-4">
  <Button
    variant="outline"
    onClick={() => signInWithGoogle()}
    disabled={loading}
    type="button"
  >
    <FcGoogle className="mr-2 h-4 w-4" />
    Google
  </Button>
  <Button
    variant="outline"
    onClick={() => signInWithApple()}
    disabled={loading}
    type="button"
  >
    <FaApple className="mr-2 h-4 w-4" />
    Apple
  </Button>
</div>
```

### Step 5: Install Icon Dependencies (if needed)

```bash
npm install react-icons
```

## SUPABASE CONFIGURATION (Manual Steps)

These require manual configuration in Supabase Dashboard:

### Google OAuth
1. Go to Supabase Dashboard → Authentication → Providers → Google
2. Enable Google provider
3. Add Client ID and Client Secret from Google Cloud Console
4. Redirect URL: `https://[PROJECT_REF].supabase.co/auth/v1/callback`

### Apple OAuth
1. Go to Supabase Dashboard → Authentication → Providers → Apple
2. Enable Apple provider
3. Add Service ID, Team ID, Key ID, and Private Key from Apple Developer Console
4. Redirect URL: `https://[PROJECT_REF].supabase.co/auth/v1/callback`

## VERIFICATION

After implementation:
- [ ] Google sign-in creates new user and profile
- [ ] Apple sign-in creates new user and profile
- [ ] Existing users can link social accounts
- [ ] OAuth callback handles errors gracefully
- [ ] Loading states show during OAuth flow

$END$

Context: OAuth implementation for Mobul platform
